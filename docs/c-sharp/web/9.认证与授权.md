# è®¤è¯ä¸æˆæƒ

## è®¤è¯ï¼ˆAuthenticationï¼‰æ–¹å¼

å¥½çš„ ğŸ‘
æˆ‘å¸®ä½ æŠŠ **.NET Core å¸¸è§è®¤è¯æ–¹å¼**ï¼ˆCookieã€JWTã€OAuth2.0/OpenID Connectã€è¯ä¹¦è®¤è¯ï¼‰åˆ†åˆ«æ¢³ç† **è®¤è¯æµç¨‹** å’Œ **å®ç°æ­¥éª¤**ï¼Œè¿™æ ·ä½ èƒ½æ¸…æ™°çœ‹åˆ°å®ƒä»¬çš„åº”ç”¨åœºæ™¯å’Œä»£ç ç¤ºä¾‹ã€‚

---

### 1. Cookie è®¤è¯

#### æµç¨‹

1. ç”¨æˆ·æäº¤è´¦å·å¯†ç åˆ°æœåŠ¡ç«¯ã€‚
2. æœåŠ¡ç«¯éªŒè¯é€šè¿‡åï¼Œç”Ÿæˆä¸€ä¸ª **åŠ å¯†çš„è®¤è¯ç¥¨æ®ï¼ˆAuthentication Ticketï¼‰** å¹¶å­˜å…¥ Cookieã€‚
3. åç»­è¯·æ±‚ä¸­æµè§ˆå™¨è‡ªåŠ¨å¸¦ä¸Š Cookieã€‚
4. æœåŠ¡ç«¯é€šè¿‡è§£å¯†éªŒè¯ Cookieï¼Œæ¢å¤ç”¨æˆ·èº«ä»½ã€‚

#### å®ç°

```csharp
// Startup.cs æˆ– Program.cs
services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.LoginPath = "/Account/Login"; // æœªç™»å½•æ—¶è·³è½¬
        options.AccessDeniedPath = "/Account/AccessDenied";
    });

// ç™»å½•æ—¶å†™å…¥ Cookie
public async Task<IActionResult> Login(string username, string password)
{
    if (username == "admin" && password == "123456")
    {
        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.Name, username),
            new Claim(ClaimTypes.Role, "Admin")
        };
        var claimsIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, new ClaimsPrincipal(claimsIdentity));
        return Redirect("/");
    }
    return Unauthorized();
}
```

---

### 2. JWT è®¤è¯ï¼ˆå¸¸ç”¨äºå‰åç«¯åˆ†ç¦»ï¼‰

#### æµç¨‹

1. ç”¨æˆ·æäº¤è´¦å·å¯†ç åˆ°æœåŠ¡ç«¯ã€‚
2. æœåŠ¡ç«¯éªŒè¯æˆåŠŸåç”Ÿæˆ **JWT Token**ï¼ˆåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œç­¾åï¼‰ã€‚
3. å‰ç«¯ä¿å­˜ Tokenï¼ˆä¸€èˆ¬æ”¾ LocalStorage æˆ– SessionStorageï¼‰ã€‚
4. åç»­è¯·æ±‚åœ¨ `Authorization: Bearer <token>` ä¸­ä¼ ç»™æœåŠ¡ç«¯ã€‚
5. æœåŠ¡ç«¯ç”¨å¯†é’¥éªŒè¯ Tokenï¼Œè§£æç”¨æˆ·ä¿¡æ¯ã€‚

#### å®ç°

```csharp
// Startup.cs æˆ– Program.cs
services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = "yourIssuer",
            ValidAudience = "yourAudience",
            IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes("SuperSecretKey12345"))
        };
    });

// ç”Ÿæˆ Token
public string GenerateJwtToken(string username)
{
    var claims = new[]
    {
        new Claim(ClaimTypes.Name, username),
        new Claim(ClaimTypes.Role, "Admin")
    };
    var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes("SuperSecretKey12345"));
    var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

    var token = new JwtSecurityToken(
        issuer: "yourIssuer",
        audience: "yourAudience",
        claims: claims,
        expires: DateTime.Now.AddHours(1),
        signingCredentials: creds);

    return new JwtSecurityTokenHandler().WriteToken(token);
}
```

---

### 3. OAuth2.0 / OpenID Connectï¼ˆå¸¸ç”¨äºå•ç‚¹ç™»å½•ï¼‰

#### æµç¨‹

1. ç”¨æˆ·è®¿é—®å—ä¿æŠ¤èµ„æºï¼Œè¢«é‡å®šå‘åˆ° **èº«ä»½æä¾›å•†ï¼ˆIdPï¼‰**ï¼ˆå¦‚ Azure ADã€IdentityServerã€Googleï¼‰ã€‚
2. ç”¨æˆ·åœ¨ IdP ç™»å½•ã€‚
3. IdP è¿”å› **æˆæƒç ï¼ˆAuthorization Codeï¼‰** ç»™åº”ç”¨ã€‚
4. åº”ç”¨ç”¨æˆæƒç å‘ IdP è¯·æ±‚ **Access Token / ID Token**ã€‚
5. åº”ç”¨ç”¨ Token éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œå¹¶è·å–ç”¨æˆ·ä¿¡æ¯ã€‚

#### å®ç°ï¼ˆä»¥ OpenIdConnect + Azure AD ä¸ºä¾‹ï¼‰

```csharp
services.AddAuthentication(options =>
{
    options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;
})
.AddCookie()
.AddOpenIdConnect(options =>
{
    options.Authority = "https://login.microsoftonline.com/{tenantId}/v2.0";
    options.ClientId = "your-client-id";
    options.ClientSecret = "your-client-secret";
    options.ResponseType = "code"; // æˆæƒç æ¨¡å¼
    options.SaveTokens = true;
    options.Scope.Add("profile");
    options.Scope.Add("email");
});
```

---

### 4. è¯ä¹¦è®¤è¯ï¼ˆClient Certificateï¼‰

#### æµç¨‹

1. å®¢æˆ·ç«¯æŒæœ‰ä¸€ä¸ªæ•°å­—è¯ä¹¦ï¼ˆ.pfxï¼‰ã€‚
2. è¯·æ±‚æ—¶æµè§ˆå™¨/å®¢æˆ·ç«¯ä¼šé™„å¸¦è¯ä¹¦ã€‚
3. æœåŠ¡å™¨éªŒè¯è¯ä¹¦æ˜¯å¦å¯ä¿¡ï¼ˆCA ç­¾å‘ã€æœªè¿‡æœŸã€æ˜¯å¦åŠé”€ï¼‰ã€‚
4. éªŒè¯é€šè¿‡åå»ºç«‹å®‰å…¨ä¼šè¯ã€‚

#### å®ç°

```csharp
services.AddAuthentication(
    CertificateAuthenticationDefaults.AuthenticationScheme)
    .AddCertificate(options =>
    {
        options.AllowedCertificateTypes = CertificateTypes.Chained; // åªå…è®¸ CA ç­¾å‘çš„è¯ä¹¦
        options.Events = new CertificateAuthenticationEvents
        {
            OnCertificateValidated = context =>
            {
                var claims = new[]
                {
                    new Claim(ClaimTypes.NameIdentifier, context.ClientCertificate.Subject, ClaimValueTypes.String, context.Options.ClaimsIssuer),
                    new Claim(ClaimTypes.Name, context.ClientCertificate.Subject, ClaimValueTypes.String, context.Options.ClaimsIssuer)
                };
                context.Principal = new ClaimsPrincipal(new ClaimsIdentity(claims, context.Scheme.Name));
                context.Success();
                return Task.CompletedTask;
            }
        };
    });
```
---

## ASP.NET Core æˆæƒæœºåˆ¶å¯¹æ¯”

åœ¨ ASP.NET Core ä¸­ï¼Œæˆæƒä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š

### **åŸºäºè§’è‰²çš„æˆæƒï¼ˆRole-based Authorizationï¼‰**

- æ ¸å¿ƒæ€æƒ³ï¼š

* ç”¨æˆ·è¢«åˆ†é…ä¸€ä¸ªæˆ–å¤šä¸ª **è§’è‰²ï¼ˆRoleï¼‰**ï¼Œè®¿é—®æ—¶æ ¹æ®è§’è‰²åˆ¤æ–­æƒé™ã€‚

ğŸ”¹ ç”¨æ³•ç¤ºä¾‹ï¼š

```csharp
[Authorize(Roles = "Admin")]
public IActionResult AdminOnly()
{
    return View();
}
```

ğŸ”¹ ç‰¹ç‚¹ï¼š

* ç®€å•ã€ç›´è§‚ã€‚
* é€‚åˆ **è§’è‰²å›ºå®š** çš„ç³»ç»Ÿï¼ˆæ¯”å¦‚ï¼šç®¡ç†å‘˜ / æ™®é€šç”¨æˆ· / è®¿å®¢ï¼‰ã€‚
* ç¼ºç‚¹ï¼šæ‰©å±•æ€§å·®ï¼Œå¦‚æœæƒé™éœ€æ±‚è¶Šæ¥è¶Šå¤æ‚ï¼Œè§’è‰²æ•°é‡ä¼šçˆ†ç‚¸ï¼ˆè§’è‰²è†¨èƒ€é—®é¢˜ï¼‰ã€‚

---

### **åŸºäºå£°æ˜çš„æˆæƒï¼ˆClaims-based Authorizationï¼‰**

ğŸ‘‰ æ ¸å¿ƒæ€æƒ³ï¼š

* ç”¨æˆ·èº«ä»½åŒ…å«ä¸€ç»„ **å£°æ˜ï¼ˆClaimsï¼‰**ï¼Œå£°æ˜æ˜¯â€œé”®å€¼å¯¹â€ï¼Œæ¯”å¦‚ï¼š

  * `Department = Sales`
  * `Permission = ReadOrders`

ğŸ”¹ ç”¨æ³•ç¤ºä¾‹ï¼š

```csharp
[Authorize(Policy = "SalesOnly")]
public IActionResult SalesAction()
{
    return View();
}

// Startup / Program.cs ä¸­å®šä¹‰ç­–ç•¥
services.AddAuthorization(options =>
{
    options.AddPolicy("SalesOnly",
        policy => policy.RequireClaim("Department", "Sales"));
});
```

ğŸ”¹ ç‰¹ç‚¹ï¼š

* æ¯”è§’è‰²æ›´çµæ´»ï¼Œæƒé™å¯ä»¥åŸºäºä»»æ„å±æ€§åˆ¤æ–­ã€‚
* å¸¸ç”¨äº **å¤šç§Ÿæˆ·ç³»ç»Ÿ**ã€**éœ€è¦ç»†ç²’åº¦æ§åˆ¶çš„ä¸šåŠ¡**ã€‚
* ç¼ºç‚¹ï¼šç­–ç•¥å†™å¤šäº†ï¼Œç®¡ç†å¯èƒ½æ¯”è¾ƒå¤æ‚ã€‚

---

### **åŸºäºç­–ç•¥çš„æˆæƒï¼ˆPolicy-based Authorizationï¼‰**

ğŸ‘‰ æ ¸å¿ƒæ€æƒ³ï¼š

* å°†æˆæƒé€»è¾‘æŠ½è±¡ä¸º **ç­–ç•¥ï¼ˆPolicyï¼‰**ï¼Œç­–ç•¥é‡Œå¯ä»¥åŒ…å«è§’è‰²ã€å£°æ˜ï¼Œç”šè‡³è‡ªå®šä¹‰é€»è¾‘ã€‚

ğŸ”¹ ç”¨æ³•ç¤ºä¾‹ï¼š

```csharp
[Authorize(Policy = "Over18Only")]
public IActionResult AdultContent()
{
    return View();
}

// Startup / Program.cs
services.AddAuthorization(options =>
{
    options.AddPolicy("Over18Only", policy =>
        policy.Requirements.Add(new MinimumAgeRequirement(18)));
});

// è‡ªå®šä¹‰ Handler
public class MinimumAgeRequirement : IAuthorizationRequirement
{
    public int Age { get; }
    public MinimumAgeRequirement(int age) => Age = age;
}

public class MinimumAgeHandler : AuthorizationHandler<MinimumAgeRequirement>
{
    protected override Task HandleRequirementAsync(
        AuthorizationHandlerContext context,
        MinimumAgeRequirement requirement)
    {
        var birthdate = context.User.FindFirst(c => c.Type == ClaimTypes.DateOfBirth);
        if (birthdate != null)
        {
            var age = DateTime.Today.Year - DateTime.Parse(birthdate.Value).Year;
            if (age >= requirement.Age)
                context.Succeed(requirement);
        }
        return Task.CompletedTask;
    }
}
```

ğŸ”¹ ç‰¹ç‚¹ï¼š

* æœ€çµæ´»ï¼Œå¯å°è£…å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚
* é€‚åˆéœ€è¦ **å¤æ‚è§„åˆ™ã€ç»„åˆæ¡ä»¶** çš„ä¼ä¸šç³»ç»Ÿã€‚
* ç¼ºç‚¹ï¼šå¼€å‘æˆæœ¬ç¨é«˜ï¼Œéœ€è¦å†™ `Handler`ã€‚

---

### å¯¹æ¯”

| ç‰¹æ€§     | åŸºäºè§’è‰²       | åŸºäºå£°æ˜                 | åŸºäºç­–ç•¥               |
| -------- | -------------- | ------------------------ | ---------------------- |
| ç®€å•æ€§   | â­â­â­â­           | â­â­â­                      | â­                      |
| çµæ´»æ€§   | â­              | â­â­â­                      | â­â­â­â­                   |
| é€‚ç”¨åœºæ™¯ | è§’è‰²åˆ†æ˜çš„ç³»ç»Ÿ | å¤šç§Ÿæˆ·ã€æŒ‰å±æ€§åŒºåˆ†æƒé™   | å¤æ‚è§„åˆ™ã€å¤šæ¡ä»¶åˆ¤æ–­   |
| æ‰©å±•æ€§   | å·®ï¼ˆè§’è‰²è†¨èƒ€ï¼‰ | ä¸­ç­‰ï¼ˆä¾èµ– Claims ç®¡ç†ï¼‰ | é«˜ï¼ˆå¯è‡ªå®šä¹‰ Handlerï¼‰ |

---
