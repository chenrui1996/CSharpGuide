# 主机(Host)
::: tip 参考文档
- [WebApplication and WebApplicationBuilder in Minimal API apps](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/webapplication?view=aspnetcore-8.0)
- [.NET Generic Host in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-8.0)
- [ASP.NET Core Web Host](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/web-host?view=aspnetcore-8.0)
::: 

主机 (Host) 是一个包含应用启动和生命周期管理的对象。

它在整个应用的运行期间负责配置和管理依赖项、配置选项、日志记录、应用生命周期事件等。

NET Core 中有两种主要的主机模型：
- **Web 主机（Web Host）：** 专门用于 ASP.NET Core Web 应用，但随着 .NET Core 3.0 的发布，通用主机已经成为首选，Web 主机主要用于兼容旧版本。
- **通用主机（Generic Host）：** 可用于所有类型的应用程序（包括控制台应用、后台服务等）。
- **WebApplication and WebApplicationBuilder** ：是 .NET 6 简化 ASP.NET Core Web 应用开发的核心组件。相较于之前的通用主机（Generic Host）和 Web 主机（Web Host），它们将构建主机、配置服务、设置请求管道的步骤整合在一起。

::: tip 备注
Host的配置主要分为：
1. **Host相关配置**：如服务器、日志等
2. **依赖注入相关服务**：如 MVC 控制器服务、第三方服务等。
3. **添加中间件及管道**：如使用授权中间件、路由匹配中间件等。
4. **其他配置**：如MapControllers等路由配置。

本文主要介绍Host相关配置，其他配置参考其他章节。
:::

## 端口设置
1. Urls配置
Program.cs
``` C#
// 方式一：启动时绑定
app.Run("http://localhost:3000");

// 方式二：启动前配置。可以绑定多个端口
app.Urls.Add("http://*:3000");
app.Urls.Add("http://*:9001");
```

从配置文件读取
Program.cs
``` c#
var port = builder.Configuration["Port"] ?? "3000";
app.Urls.Add($"http://*:{port}");
```

appsettings.json/appsettings.{Environment}.json
``` json
{
  "Port": 9002
}
```

2. UseUrls()配置
Program.cs
``` c#
builder.WebHost.UseUrls("http://*:9001");
```

3. 通过ASPNETCORE_URLS环境变量设置
在项目目录下打开使用命令行设置并启动项目：
windows：
``` bash
set ASPNETCORE_URLS=http://localhost:5000
dotnet run
```

Linux/MacOS
``` bash
export ASPNETCORE_URLS="http://localhost:5000"
dotnet run

```

::: warn 注意
该方式仅在当前命令行窗口生效
:::


4. launchSettings.json配置
注意选择运行选项。

launchSettings.json
``` json
"http": {
  "commandName": "Project",
  "launchBrowser": true,
  "applicationUrl": "https://localhost:9000",
  "environmentVariables": {
    "ASPNETCORE_ENVIRONMENT": "Development"
  }
}
```

5. 使用dotnet —urls 命令行参数启动
在项目目录下打开使用命令行设置并启动项目：
``` bash
dotnet run --urls http://localhost:7001;https://localhost:7011
```

以上各种方式优先级顺序为：
使用dotnet —urls 命令行参数启动 > launchSettings.json配置 > Urls配置 > UseUrls > 环境变量 > 默认值

::: tip .net 6以前版本的配置
.net 6以前版本使用ConfigureWebHostDefaults配置
``` C#
public static IHostBuilder CreateHostBuilder(string[] args) =>
    Host.CreateDefaultBuilder(args)
        .ConfigureWebHostDefaults(webBuilder =>
        {
            // 使用UseUrls设置监听的端口和协议
            webBuilder.UseUrls("http://localhost:3001", "https://localhost:3002");
            // 配置Kestrel服务
            webBuilder.UseKestrel(kestrelServerOptions =>
            {
                kestrelServerOptions.ListenLocalhost(3001);
                kestrelServerOptions.ListenLocalhost(3002, listenOptions => listenOptions.UseHttps());
            });
        });
```
::: 

## 配置文件

### 加载

在 .NET Core 应用程序中，appsettings.json 文件是一个常用的配置文件，用来存储应用程序的各种配置信息，比如数据库连接字符串、日志设置、环境变量等。

应用程序在启动时会自动加载并解析 appsettings.json 文件的内容，然后通过配置系统（IConfiguration）来访问这些数据。

在 ASP.NET Core 6.0+ 的最简化启动模式中，appsettings.json 是通过 WebApplicationBuilder 进行加载的。

WebApplicationBuilder 在创建时（`WebApplication.CreateBuilder(args)`）默认会加载配置文件，并将配置存储在 IConfiguration 接口中。

### 访问

可以通过 builder.Configuration 来访问配置。

比如，空项目模板中有以下配置
```
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

可以使用以下代码来读取：
``` C#
var builder = WebApplication.CreateBuilder(args);

var configuration = builder.Configuration;
var logLevel = configuration["Logging:LogLevel:Default"]; // 获取嵌套属性

Console.WriteLine($"Default Log Level: {logLevel}");// 在启动的控制台输出：Default Log Level: Information

```

### 加载自定义配置文件
你可以手动添加其他配置文件，或者覆盖默认的 appsettings.json 文件。

然后使用 `builder.Configuration.AddJsonFile()`方法可以加载自定义的配置文件。

``` C#
var builder = WebApplication.CreateBuilder(args);

// 手动添加其他配置文件
builder.Configuration.AddJsonFile("customsettings.json", optional: true, reloadOnChange: true);

```

- optional: true 表示如果 customsettings.json 文件不存在，不会抛出异常。
- reloadOnChange: true 表示当文件发生更改时，会自动重新加载配置。

### 不同环境的配置
.NET Core 支持按环境加载不同的配置文件。你可以根据运行环境（如开发、测试或生产）定义不同的配置。

常见的环境有：
- Development（开发环境）
- Production（生产环境）
例如，在开发环境中，appsettings.Development.json 文件会被加载，用来覆盖 appsettings.json 中的配置。

使用命令行参数`dotnet run --environment "Development"`可以指定环境。

加载的优先级顺序通常是：
1. appsettings.json（基础配置）
2. appsettings.{Environment}.json（根据环境覆盖配置）
3. UserSecrets
4. 环境变量
5. 命令行参数

## 配置 Kestrel 服务器

Kestrel 是 ASP.NET Core 默认的跨平台 Web 服务器，用于处理 HTTP 请求。

通过 ConfigureKestrel 方法，你可以详细控制 Kestrel 服务器的行为，例如监听的端口、最大请求大小、超时设置等。

``` C#
builder.WebHost.ConfigureKestrel(options =>
{
    // 限制请求大小
    options.Limits.MaxRequestBodySize = 10 * 1024 * 1024;
    // 请求头读取超时时间
    options.Limits.RequestHeadersTimeout = TimeSpan.FromSeconds(30);
    // 最大并发连接数
    options.Limits.MaxConcurrentConnections = 100;
    // WebSocket等升级连接的最大并发数
    options.Limits.MaxConcurrentUpgradedConnections = 100;
    //通过限制请求速率来防止 DoS 攻击：
    //MinRequestBodyDataRate：设置请求体的最小数据传输速率。
    //bytesPerSecond：最低传输速率（字节 / 秒）。
    //gracePeriod：在此时间内，服务器不会强制执行速率限制
    options.Limits.MinRequestBodyDataRate =
        new MinDataRate(bytesPerSecond: 100, gracePeriod: TimeSpan.FromSeconds(10));
    // 设置请求队列大小
    // 请求行的最大长度
    options.Limits.MaxRequestLineSize = 8192;
    // 请求缓冲区的大小
    options.Limits.MaxRequestBufferSize = 65536; 
});
```

::: tip .net 6以前版本的配置
.net 6以前版本使用ConfigureWebHostDefaults配置
``` C#
public static IHostBuilder CreateHostBuilder(string[] args) =>
    Host.CreateDefaultBuilder(args)
        .ConfigureWebHostDefaults(webBuilder =>
        {
            // 配置Kestrel服务
            webBuilder.UseKestrel(options =>
            {
                // 限制请求大小
                options.Limits.MaxRequestBodySize = 10 * 1024 * 1024;
                // 请求头读取超时时间
                options.Limits.RequestHeadersTimeout = TimeSpan.FromSeconds(30);
                // 最大并发连接数
                options.Limits.MaxConcurrentConnections = 100;
                // WebSocket等升级连接的最大并发数
                options.Limits.MaxConcurrentUpgradedConnections = 100;
                //通过限制请求速率来防止 DoS 攻击：
                //MinRequestBodyDataRate：设置请求体的最小数据传输速率。
                //bytesPerSecond：最低传输速率（字节 / 秒）。
                //gracePeriod：在此时间内，服务器不会强制执行速率限制
                options.Limits.MinRequestBodyDataRate =
                    new MinDataRate(bytesPerSecond: 100, gracePeriod: TimeSpan.FromSeconds(10));
                // 设置请求队列大小
                // 请求行的最大长度
                options.Limits.MaxRequestLineSize = 8192;
                // 请求缓冲区的大小
                options.Limits.MaxRequestBufferSize = 65536; 
            });
        });
```
::: 