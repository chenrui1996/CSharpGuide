# 中间件(Middleware)
::: tip 参考文档
- [ASP.NET Core Middleware](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-8.0)
::: 

在 .NET Core 中，中间件（Middleware）是构建应用程序管道的核心组件，它决定了请求如何被处理以及响应如何生成。

每个中间件组件负责处理请求和响应，并且可以选择将请求传递给管道中的下一个中间件。

**中间件按顺序执行，因此添加的顺序至关重要。**

在 ASP.NET Core 中，HTTP 请求从客户端发出，经过中间件管道中的各个中间件，最后由应用程序生成响应。

每个中间件都可以执行以下操作：

1. **处理请求**：直接生成响应，而不传递给下一个中间件。
2. **传递请求**：将请求传递给下一个中间件。
3. **处理响应**：在接收到下一个中间件或应用程序的响应后对其进行处理。

示例：
.net 6 及之后版本
``` C#
var app = builder.Build();
app.UseXXX();
```

.net 6 之前版本
``` C#
public class Startup
{
    public void Configure(IApplicationBuilder app)
    {
        app.UseXXX();
    }
}
```

## 内置的中间件
WebApplication会根据特定条件自动在Minimal API应用中添加以下中间件：

### UseStaticFiles

app.UseStaticFiles() 是 ASP.NET Core 中的一个中间件，用于处理静态文件的请求。

静态文件通常是指无需服务器端处理即可直接发送到客户端的文件，如 HTML、CSS、JavaScript、图像、字体等资源。

该中间件允许直接从文件系统中提供这些资源。

#### 处理静态文件
通过 app.UseStaticFiles() 中间件，任何位于项目的 wwwroot 目录中的文件都可以被访问。

Program.cs
``` C#
app.UseStaticFiles();
```

例如，如果你在 wwwroot 目录中有一个名为 index.html 的文件，可以通过 http://localhost:[your port]/index.html 来访问它。

index.html
``` html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>主页</title>
</head>
<body>
    这是主页的静态文件
</body>
</html>
```

效果：
![图片](pictures/StaticFile1.png)

#### 自定义静态文件目录
如果你希望将静态文件放在 wwwroot 目录之外的其他目录中，可以通过配置 StaticFileOptions 来实现。
``` C#
app.UseStaticFiles(new StaticFileOptions
{
    FileProvider = new PhysicalFileProvider(Path.Combine(Directory.GetCurrentDirectory(), "staticfiles")),
    RequestPath = "/staticfiles"
});
```

要访问该文件夹中的文件，URL 必须包含 /StaticFiles 作为请求路径前缀。

例如，如果 MyStaticFiles 文件夹中有一个名为 test.jpg 的文件，

它将通过 http://localhost:[your port]/staticfiles/test.jpg 来访问

效果：
![图片](pictures/StaticFile2.png)

#### 禁用或限制访问
可以通过配置 StaticFileOptions 来限制对某些文件或文件夹的访问。以下示例演示了如何禁止访问 .config 文件
``` C#
app.UseStaticFiles(new StaticFileOptions
{
    FileProvider = new PhysicalFileProvider(Path.Combine(Directory.GetCurrentDirectory(), "staticfiles")),
    RequestPath = "/staticfiles",
    //禁用文件
    OnPrepareResponse = ctx =>
    {
        if (ctx.File.Name.EndsWith(".json"))
        {
            ctx.Context.Response.StatusCode = 403;
            ctx.Context.Response.ContentLength = 0;
            ctx.Context.Response.Body = Stream.Null;
            //缓存时间
            ctx.Context.Response.Headers.Append("Cache-Control", "public,max-age=600");
        }
    }
});
```

效果：
![图片](pictures/StaticFile4.png)



#### 启用文件浏览
默认情况下，UseStaticFiles() 不支持目录浏览。如果用户请求一个文件夹，服务器不会返回文件列表。

若想启用目录浏览功能，可以使用 UseDirectoryBrowser() 中间件：

``` C#
app.UseDirectoryBrowser(new DirectoryBrowserOptions
{
    FileProvider = new PhysicalFileProvider(Path.Combine(Directory.GetCurrentDirectory(), "staticfiles")),
    RequestPath = "/staticfiles"
});
```

效果：
![图片](pictures/StaticFile3.png)

### UseRouting

### UseEndpoints

### UseAuthorization 和 UseAuthorization

### UseCors

### UseExceptionHandler

### UseRateLimiter

### UseResponseCaching

## 自定义中间件

### Request and response

### Request decompression

### Factory-based middleware

